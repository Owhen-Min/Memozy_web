<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi Quiz Show Test</title>
</head>
<body>
<h2>Multi Quiz Show í…ŒìŠ¤íŠ¸ (WebSocket + JWT Optional)</h2>

<label>Show ID: </label>
<input id="showId" value="EURO2025">
<br><br>

<button>Connect & Join</button>

<div id="status" style="margin-top: 10px;"></div>

<div id="broadcasts" style="margin-top: 20px; border: 1px solid gray; padding: 10px;">
    <strong>ğŸ“¢ Broadcast ë©”ì‹œì§€ ë¡œê·¸</strong>
    <ul id="broadcastList" style="list-style: none; padding-left: 0;"></ul>
</div>

<div id="participants" style="margin-top: 20px; border: 1px solid gray; padding: 10px;">
    <strong>ğŸ§‘â€ğŸ¤â€ğŸ§‘ í˜„ì¬ ì°¸ê°€ì ëª©ë¡</strong>
    <ul id="participantList" style="list-style: none; padding-left: 0;"></ul>
</div>

<script type="module">
    import {Client} from 'https://cdn.jsdelivr.net/npm/@stomp/stompjs/+esm';

    function connect() {
        const showId = document.getElementById("showId").value;
        const token = localStorage.getItem("jwtToken");
        const headers = token ? {Authorization: "Bearer " + token} : {};

        console.log("ğŸ› ï¸ ì—°ê²° ì‹œë„: showId =", showId);
        if (token) {
            console.log("ğŸ” JWT Token ê°ì§€ë¨ (prefix í¬í•¨):", headers.Authorization);
        } else {
            console.log("ğŸ§‘â€ğŸ¤â€ğŸ§‘ JWT Token ì—†ìŒ, ê²ŒìŠ¤íŠ¸ë¡œ ì—°ê²°");
        }

        const client = new Client({
            brokerURL: "ws://localhost:8080/ws",
            connectHeaders: headers,
            debug: (str) => console.log("[STOMP DEBUG]", str),
            reconnectDelay: 5000,

            onConnect: () => {
                console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ");
                document.getElementById("status").innerText = "âœ” ì—°ê²°ë¨";

                const subscribePath = `/sub/quiz/show/${showId}`;
                console.log("ğŸ“¡ Subscribing to", subscribePath);

                client.subscribe(subscribePath, (message) => {
                    console.log("ğŸ“¥ ìˆ˜ì‹  ë©”ì‹œì§€:", message.body);

                    const li = document.createElement("li");

                    try {
                        const body = JSON.parse(message.body);

                        if (body.type === "JOIN" && body.nickname) {
                            li.textContent = `ğŸ‘‹ ${body.nickname}ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤`;
                            document.getElementById("broadcastList").prepend(li);
                        } else if (body.type === "PARTICIPANT_LIST" && Array.isArray(body.participants)) {
                            const list = document.getElementById("participantList");
                            list.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
                            body.participants.forEach(nickname => {
                                const participantItem = document.createElement("li");
                                participantItem.textContent = nickname;
                                list.appendChild(participantItem);
                            });
                        } else {
                            li.textContent = `ğŸ“¨ type: ${body.type}, userId: ${body.userId}, nickname: ${body.nickname}`;
                            document.getElementById("broadcastList").prepend(li);
                        }
                    } catch (e) {
                        li.textContent = `ğŸ“¨ (raw): ${message.body}`;
                        document.getElementById("broadcastList").prepend(li);
                    }
                });

                const payload = {
                    nickname: "Guest957",
                    isMember: false
                };

                console.log("ğŸš€ ì°¸ê°€ ìš”ì²­ ì „ì†¡:", payload);
                client.publish({
                    destination: `/pub/quiz/show/${showId}`,
                    body: JSON.stringify(payload)
                });

                const li = document.createElement("li");
                li.textContent = "ğŸš€ ì°¸ê°€ ìš”ì²­ ì „ì†¡ë¨";
                document.getElementById("broadcastList").prepend(li);
            },

            onStompError: (frame) => {
                console.error("âŒ Broker ì—ëŸ¬:", frame.headers['message']);
                console.error("âŒ ë³¸ë¬¸:", frame.body);
                document.getElementById("status").innerText = "âŒ ì—°ê²° ì‹¤íŒ¨ (STOMP ì—ëŸ¬)";
            }
        });

        client.activate();
    }

    document.querySelector("button").addEventListener("click", connect);
</script>

</body>
</html>
