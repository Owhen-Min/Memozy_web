<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Multi Quiz Show</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<h2>Multi Quiz Show í…ŒìŠ¤íŠ¸</h2>

<!-- í† í° ì…ë ¥ -->
<label>JWT í† í°:</label>
<input id="jwtTokenInput" type="text" size="100" placeholder="Bearer ey..."/>
<button onclick="saveToken()">ì €ì¥</button>
<br><br>

<!-- í€´ì¦ˆ ì½”ë“œ ì…ë ¥ -->
<label>Show ID: </label>
<input id="showId" value="YOUR_SHOW_ID"/>
<br><br>

<button onclick="createQuizShow()">í€´ì¦ˆ ìƒì„±</button>
<button onclick="connect()">Connect & Join</button>
<button onclick="startQuiz()">Start Quiz</button>

<h3>í€´ì¦ˆ ë¬¸ì œ</h3>
<div id="quizQuestion">ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>

<h3>ì°¸ê°€ì ëª©ë¡</h3>
<ul id="participantList"></ul>

<h3>ê²°ê³¼ ë¡œê·¸</h3>
<ul id="resultLog"></ul>

<script>
    let stompClient = null;
    let showId = null;

    function saveToken() {
        const token = document.getElementById("jwtTokenInput").value;
        if (!token.startsWith("Bearer ")) {
            alert("âš ï¸ Bearer í¬í•¨í•´ì„œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }
        localStorage.setItem("jwtToken", token);
        alert("âœ… í† í° ì €ì¥ ì™„ë£Œ");
    }

    function createQuizShow() {
        const jwtToken = localStorage.getItem("jwtToken");
        const collectionId = prompt("ì»¬ë ‰ì…˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        const count = 10;

        fetch(`/api/quiz/show/${collectionId}?count=${count}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                ...(jwtToken && {Authorization: jwtToken})
            }
        })
            .then(response => response.json())
            .then(data => {
                const result = data.data;
                document.getElementById("showId").value = result.showId;
                logResult(`âœ… í€´ì¦ˆ ìƒì„± ì™„ë£Œ. showId: ${result.showId}`);
            })
            .catch(error => {
                logResult(`âŒ í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨: ${error}`);
            });
    }

    function connect() {
        showId = document.getElementById("showId").value;
        const socket = new SockJS("/ws-connect");
        stompClient = Stomp.over(socket);

        const jwtToken = localStorage.getItem("jwtToken");
        const headers = jwtToken ? {Authorization: jwtToken} : {};

        stompClient.connect(headers, () => {
            logResult(`âœ” WebSocket ì—°ê²°ë¨ (showId: ${showId})`);

            // ì°¸ê°€ ìš”ì²­
            stompClient.send(`/pub/quiz/show/${showId}/join`, {}, JSON.stringify({}));

            // ì°¸ê°€ì ì…ì¥ ì•Œë¦¼
            stompClient.subscribe(`/sub/quiz/show/${showId}/join`, (message) => {
                const payload = JSON.parse(message.body);
                logResult(`ğŸŸ¢ ${payload.nickname} ë‹˜ ì°¸ê°€`);
            });

            // ì°¸ê°€ì ëª©ë¡
            stompClient.subscribe(`/sub/quiz/show/${showId}/participants`, (message) => {
                const data = JSON.parse(message.body);
                const list = document.getElementById("participantList");
                list.innerHTML = '';
                data.participants.forEach(nickname => {
                    const li = document.createElement("li");
                    li.textContent = nickname;
                    list.appendChild(li);
                });
            });

            // âœ… í€´ì¦ˆ ë¬¸ì œ ìˆ˜ì‹ 
            stompClient.subscribe(`/sub/quiz/show/${showId}/quiz`, (message) => {
                const data = JSON.parse(message.body);
                const index = data.index;
                const quiz = data.quiz;
                document.getElementById("quizQuestion").innerText = `ğŸ§  [Q${index + 1}] ${quiz}`;
                logResult(`ğŸ“¥ ë¬¸ì œ ìˆ˜ì‹  ì™„ë£Œ`);
            });

            // ì „ì²´ ê²°ê³¼ ìˆ˜ì‹ 
            stompClient.subscribe(`/sub/quiz/show/${showId}/result`, (message) => {
                const result = JSON.parse(message.body);
                logResult(`ğŸ ê²°ê³¼: ${result.type}, ê°€ì¥ ë§ì´ í‹€ë¦° ë¬¸ì œ: ${result.wrongQuizResultResponse}`);
            });

        }, (error) => {
            logResult("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: " + error);
        });
    }

    function startQuiz() {
        if (!stompClient || !showId) {
            alert("ë¨¼ì € WebSocket ì—°ê²°í•˜ì„¸ìš”.");
            return;
        }
        stompClient.send(`/pub/quiz/show/${showId}/start`, {}, JSON.stringify({}));
        logResult("ğŸš€ í€´ì¦ˆ ì‹œì‘ ìš”ì²­ ì „ì†¡");
    }

    function logResult(message) {
        const logList = document.getElementById("resultLog");
        const li = document.createElement("li");
        li.textContent = message;
        logList.appendChild(li);
    }
</script>
</body>
</html>
